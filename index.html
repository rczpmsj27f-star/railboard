<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Departures — Manchester Piccadilly</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
    body {
        margin: 0;
        background: #0a0f1f;
        font-family: "Inter", Arial, sans-serif;
        color: white;
        overflow: hidden;
    }

    header {
        background: #0d132b;
        padding: 20px;
        font-size: 2.5vw;
        font-weight: 600;
        text-align: center;
        border-bottom: 2px solid rgba(255,255,255,0.1);
    }

    table {
        width: 100%;
        border-collapse: collapse;
        table-layout: fixed;
        font-size: 1.8vw;
    }

    th {
        text-align: left;
        padding: 10px 20px;
        font-weight: 500;
        color: #cfd8ff;
        border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    td {
        padding: 12px 20px;
        border-bottom: 1px solid rgba(255,255,255,0.05);
        cursor: pointer;
    }

    tr {
        transition: background 0.3s ease;
    }

    tr:hover {
        background: rgba(255,255,255,0.05);
    }

    .etd-delayed {
        color: #f8d648;
        font-weight: 600;
    }

    .cancelled {
        color: #ff4d4d;
        font-weight: 700;
    }

    /* Popup */
    #popup {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.7);
        display: none;
        align-items: center;
        justify-content: center;
    }

    #popup-content {
        background: #0d132b;
        padding: 30px;
        border-radius: 10px;
        width: 60%;
        max-height: 70%;
        overflow-y: auto;
        font-size: 1.5vw;
    }

    #popup h2 {
        margin-top: 0;
        color: #f8d648;
    }

    #close-popup {
        margin-top: 20px;
        padding: 10px 20px;
        background: #f8d648;
        border: none;
        border-radius: 5px;
        font-size: 1.2vw;
        cursor: pointer;
    }
</style>
</head>

<body>

<header>Departures — Manchester Piccadilly</header>

<table>
    <thead>
        <tr>
            <th style="width:15%">Time</th>
            <th style="width:40%">Destination</th>
            <th style="width:15%">Platform</th>
            <th style="width:15%">Expected</th>
            <th style="width:15%">Operator</th>
        </tr>
    </thead>
    <tbody id="departures"></tbody>
</table>

<!-- Popup -->
<div id="popup">
    <div id="popup-content">
        <h2>Calling Points</h2>
        <div id="calling-points"></div>
        <button id="close-popup">Close</button>
    </div>
</div>

<script>
const WORKER_URL = "https://newrail.trr4qy5vhk.workers.dev/api/departures?crs=MAN&numRows=50";

async function loadDepartures() {
    try {
        const res = await fetch(WORKER_URL);
        const data = await res.json();

        const tbody = document.getElementById("departures");
        tbody.innerHTML = "";

        if (!data.trainServices) return;

        data.trainServices.forEach(service => {

            // --- Determine origin and raw destination ---
            const origin = service.origin?.[0]?.locationName || "";
            const destinationRaw = service.destination?.[0]?.locationName || "";

            // --- 1. Skip terminating services (no onward calling points) ---
            const hasOnward = service.subsequentCallingPoints?.[0]?.callingPoint?.length > 0;
            if (destinationRaw === "Manchester Piccadilly" && !hasOnward) {
                return;
            }

            // --- 2. Determine the REAL destination ---
            let destination = destinationRaw;

            // If Darwin incorrectly reports MAN as destination, use first onward stop
            if (destinationRaw === "Manchester Piccadilly") {
                const onward = service.subsequentCallingPoints?.[0]?.callingPoint?.[0]?.locationName;
                if (onward) destination = onward;
            }

            // --- 3. Skip services that start AND end at MAN ---
            if (origin === "Manchester Piccadilly" && destination === "Manchester Piccadilly") {
                return;
            }

            // --- 4. Skip anything still showing MAN as destination ---
            if (destination === "Manchester Piccadilly") {
                return;
            }

            const row = document.createElement("tr");

            const isCancelled = service.isCancelled;
            const etd = service.etd;

            row.innerHTML = `
                <td>${service.std || ""}</td>
                <td>${destination}</td>
                <td>${service.platform || ""}</td>
                <td class="${isCancelled ? "cancelled" : (etd !== "On time" ? "etd-delayed" : "")}">
                    ${isCancelled ? "Cancelled" : etd}
                </td>
                <td>${service.operator || ""}</td>
            `;

            row.onclick = () => showCallingPoints(service);

            tbody.appendChild(row);
        });

    } catch (err) {
        console.error("Error loading departures:", err);
    }
}

function showCallingPoints(service) {
    const popup = document.getElementById("popup");
    const cpDiv = document.getElementById("calling-points");

    cpDiv.innerHTML = "";

    const cps = service.subsequentCallingPoints?.[0]?.callingPoint || [];

    cps.forEach(cp => {
        const line = document.createElement("div");
        line.style.marginBottom = "8px";

        if (cp.isCancelled) {
            line.innerHTML = `<span style="color:#ff4d4d;font-weight:700">${cp.locationName} — Cancelled</span>`;
        } else {
            line.textContent = `${cp.locationName}  ${cp.st} → ${cp.et}`;
        }

        cpDiv.appendChild(line);
    });

    popup.style.display = "flex";
}

document.getElementById("close-popup").onclick = () => {
    document.getElementById("popup").style.display = "none";
};

loadDepartures();
setInterval(loadDepartures, 30000);
</script>

</body>
</html>
